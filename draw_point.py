# 202.1494293 79.19758606 204.0 79.0 202.4713135 74.91516113 201.3371735 69.40557861 198.584259 66.10333252 194.3134766 60.98031616 187.1599579 61.0662117 188.1070404 50.0 188.6389313 43.78519821 199.0169983 27.57803726 205.014267 25.64943695 208.0446777 24.6749115 219.2119751 24.9532547 223.0 25.00370598 229.0023041 25.08364868 230.839798 25.55169678 235.0 30.0 239.0727539 23.02890587 249.0245361 24.96532059 256.0 25.00074196 268.4194641 25.06380653 269.657196 30.36125183 275.9970398 40.0 278.6539001 44.03933716 281.4276123 47.893116 280.7737122 53.0 279.8147278 60.48931885 274.1084595 61.3949585 270.3877869 65.32666016 266.901001 69.01117706 265.6888123 74.1386795 265.0 79.0 266.8505859 79.19758606 268.2120361 79.26289368 269.9849854 80.00537872 280.0507202 84.22070312 276.0171814 95.12515259 276.3870239 100.0 276.3870239 100.0 280.0 114.0 280.0 114.0 282.0660095 112.7079086 284.108551 111.4709702 285.8973999 109.7931595 289.8183289 106.1156158 293.9656982 97.46936035 304.0 102.4525909 305.8736877 103.3830948 307.3904114 104.6974258 309.0 106.0 309.4718933 102.442688 310.038147 97.07335663 312.0061035 94.05166626 317.450531 85.88677979 326.7406311 88.93452454 333.0 94.05166626 335.6112976 87.84098053 338.2728882 81.60756683 339.5405579 75.0 340.453125 70.24349976 340.4589539 64.11806488 343.6494446 60.21129227 348.6094971 54.13763428 358.3473816 54.87404251 362.8937073 61.10333633 371.7307129 73.21166229 369.9589539 89.81446838 372.0 97.0 372.0 97.0 377.1131592 77.0 377.1131592 77.0 378.0039062 73.13412476 378.5046082 67.42713928 380.4390564 64.10333252 382.3759155 60.77544022 385.2659302 59.4285202 389.0 59.10704041 400.5046387 58.1165657 401.1177368 65.44856262 404.0036926 74.0 408.5157776 87.36971283 414.0732117 104.5640945 420.247406 117.0 420.247406 117.0 429.3492432 134.985733 429.3492432 134.985733 434.0849304 142.7838287 434.5206909 137.6648254 440.1387024 154.0 443.2396545 163.0164032 446.985321 177.5921936 447.0 187.0 447.0 187.0 447.0 196.0 447.0 196.0 446.9772034 210.6126709 439.4658813 237.3973083 432.1244507 250.0 429.3867798 254.699585 422.2735901 262.4213867 418.4096069 267.0 411.4894714 275.2000427 395.4030762 293.0157471 385.0 295.0 385.0 295.0 386.0 303.0 386.0 303.0 399.4090271 300.8959656 408.8634949 287.9957886 418.7886963 295.0061035 423.1961365 298.1191406 423.2236938 303.1956787 422.5753784 308.0 421.1633911 318.4637451 418.9969177 326.0447388 415.6666565 336.0 408.7467041 356.6861267 393.3849792 381.4706116 379.196106 397.9577637 373.2043762 404.9200134 369.7684937 403.3586426 364.902771 410.0392761 361.8006897 414.2984009 355.5823669 426.8929749 353.8885193 432.0 352.5074158 436.1641235 352.1914062 441.3265686 349.3513184 444.7886963 346.026123 448.8421631 340.6963806 449.0962219 336.0 450.4275818 329.0937195 452.385437 324.7484436 454.5730591 319.0 458.8981628 310.8991089 464.9931641 306.9508667 469.449585 301.5431213 478.0 296.2315063 486.398407 298.0503235 492.3271179 286.0 493.0 290.3756714 499.5696106 297.45755 508.6706238 293.9938965 516.9849854 290.4219666 525.5592041 282.3084106 523.5888062 275.0 524.0883179 267.6277771 524.5922241 249.2376099 526.7005005 243.0037079 523.5466919 239.2926178 521.6691895 236.6826935 518.0806885 234.0 515.0 231.8349152 518.2212524 229.4990387 521.6966553 225.9614868 523.5466919 223.0501556 525.0691528 220.1742096 524.9831543 217.0 524.9992676 217.0 524.9992676 192.0 524.0883179 192.0 524.0883179 183.2254791 523.4886475 171.8757782 525.5892334 173.1070404 511.0 173.6047821 505.1022949 178.9098663 498.1304016 182.0 493.0 170.1873016 492.3403931 171.5879364 486.521637 166.5474091 478.0 161.9613342 470.2466431 159.0751801 466.6389771 152.0 461.0036926 146.4754639 456.6034851 141.8334961 453.3267212 135.0 451.2052002 130.1529694 449.7003784 122.931221 449.1496887 119.3914795 445.6085205 115.8061142 442.0217285 115.9746628 436.5933533 114.4811249 432.0 112.620903 426.2789917 106.982132 415.0800171 103.6529694 410.1026001 99.93013 404.5365906 94.08426666 403.974762 88.8875885 397.8973999 77.0348053 384.0359497 67.36019135 368.0882263 58.88777924 352.0 53.94823456 342.6203308 46.10964203 318.448761 46.00370789 308.0 45.92195892 299.9369202 47.7493782 291.9671021 58.0 293.2255554 62.89929199 293.8270264 69.4854126 298.4066772 74.0 300.6281433 74.0 300.6281433 81.94473267 304.0 81.94473267 304.0 82.16240692 301.896698 82.8860321 298.1988831 81.94473267 296.3877869 80.80821228 294.42276 76.9440155 292.7305298 75.0 291.3798218 70.69960022 288.3919373 65.72598267 283.713501 62.0 279.9992676 62.0 279.9992676 47.5753746 264.0 47.5753746 264.0 35.48433685 249.9712982 32.57279968 245.9548798 27.20741081 228.0 19.84808922 203.3725891 18.72298622 187.9064178 25.57685852 163.0 27.06962395 157.5754089 28.58052826 152.1601257 30.87555885 147.0007477 33.65549469 140.7512512 35.63313675 140.8247375 38.32128906 135.9614868 44.78894043 124.2605362 50.04240417 113.5517578 54.68111038 101.0 54.68111038 101.0 63.94648361 75.0 63.94648361 75.0 65.06668854 71.9080658 66.33222961 66.58031464 68.00241089 64.10333252 71.00831604 59.64540863 76.9441452 58.0308342 81.98499298 59.64943695 87.76322937 61.50481033 89.07309723 66.69753265 90.19610596 72.0 91.69869995 79.09472656 93.90341187 89.61817932 97.0 96.0 97.0 83.57180786 97.53684998 76.36862183 103.2481384 65.0 105.7494431 60.02103043 107.8864288 56.00911331 114.0 55.22629547 128.598465 53.35702133 127.6569214 71.70393372 130.4374084 81.0 130.4374084 81.0 135.0 94.0 135.0 94.0 137.8080139 92.28938293 140.7728271 90.11050415 144.0 89.39221954 155.9086151 86.74166107 158.9703979 96.50470734 159.0 106.0 164.2982941 101.7122803 171.5400238 98.3762207 177.6129608 103.649437 180.0408325 105.7575836 183.4108887 113.3420258 187.5850067 111.7024307 189.9421844 110.7765274 191.6047974 104.3399887 192.063324 102.0 193.6020813 94.14756775 188.6100616 84.36276245 199.0149994 80.00537872 200.7879639 79.26289368
import line
import sys
import math
from PyQt5.QtWidgets import *
from PyQt5.QtGui import QPainter, QPen, QWheelEvent, QColor
from PyQt5.QtCore import Qt
from PyQt5 import QtCore, QtGui
import json
import os.path

if hasattr(QtCore.Qt, 'AA_EnableHighDpiScaling'):
    QApplication.setAttribute(QtCore.Qt.AA_EnableHighDpiScaling, True)
    print('highdpi')
if hasattr(QtCore.Qt, 'AA_UseHighDpiPixmaps'):
    QApplication.setAttribute(QtCore.Qt.AA_UseHighDpiPixmaps, True)
    print('pixmap')

f = open("data.txt", 'r')
while True:
    lineData = f.readline()
    if not lineData: break
    # print(line.split(' '))
    num = lineData.split(' ')
    print(len(num))
f.close()
# num = num[0:6*10]
# for i in range(3):
#     num.append(200)
#     num.append(200)
# for i in range(3):
#     num.append(200)
#     num.append(300)
# for i in range(3):
#     num.append(300)
#     num.append(300)
# for i in range(3):
#     num.append(300)
#     num.append(200)

class BezierPoint:
    def __init__(self, x_g1, y_g1, x, y, x_g2, y_g2):
        self.x_g1 = x_g1
        self.y_g1 = y_g1
        self.x = x
        self.y = y
        self.x_g2 = x_g2
        self.y_g2 = y_g2
        self.acute = False
        self.acute2 = False

bzPoints = []
for i in range(int(len(num)/6)):
    bzPoints.append(BezierPoint(float(num[i*6]), float(num[i*6+1]), float(num[i*6+2]), float(num[i*6+3]), float(num[i*6+4]), float(num[i*6+5])))

for i in range(2):
    print(bzPoints[i].x_g1)
    print(bzPoints[i].y_g1)
    print(bzPoints[i].x)
    print(bzPoints[i].y)
    print(bzPoints[i].x_g2)
    print(bzPoints[i].y_g2)

class MyCanvas(QWidget):
    def __init__(self, parent):
        self.parent = parent
        super().__init__()

    def wheelEvent(self, event: QWheelEvent):
        print('wheel')

    def mouseMoveEvent(self, a0: QtGui.QMouseEvent) -> None:
        print('canvas mouse move event')
        self.parent.mouseMoveEvent(a0)
        return super().mouseMoveEvent(a0)


class MyApp(QMainWindow):

    def __init__(self):
        super().__init__()
        self.initUI()

    def initUI(self):
        self.bCtrl = False
        self.bShift = False
        self.showControlPoint = True
        self.movePoint = True
        self.selected_point = -1
        self.angle = 30.0
        self.zoomFactor = 1.2
        if os.path.isfile('config.json') == True:
            fp = open('config.json', 'r')
            config = json.load(fp)
            if config.get('angle'): self.angle = config['angle']
            else: self.angle = 30
            if config.get('v_org_x'): self.v_org_x = config['v_org_x']
            else: self.v_org_x = 0
            if config.get('v_org_y'): self.v_org_y = config['v_org_y']
            else: self.v_org_y = 0
            if config.get('v_w'): self.v_w = config['v_w']
            else: self.v_w = 600

        self.v_h = self.v_w
        self.w = 600
        self.h = 600
        self.zoomInCenterX = self.w*0.5
        self.zoomInCenterY = self.h*0.5

        self.scale_w = self.w/self.v_w
        self.scale_h = self.h/self.v_h
        if self.scale_w > self.scale_h:
            self.scale = self.scale_h
        else:
            self.scale = self.scale_w

        self.setGeometry(100, 100, self.w, self.h)
        self.setWindowTitle('drawLine')

        layout1 = QHBoxLayout()
        layout2 = QVBoxLayout()
        self.chkShowControlPoint = QCheckBox("Show Control Point", self)
        self.chkShowControlPoint.setChecked(self.showControlPoint)
        self.chkShowControlPoint.resize(150, 28)
        self.chkShowControlPoint.move(self.w - self.chkShowControlPoint.sizeHint().width() - 10, 5)
        self.chkShowControlPoint.stateChanged.connect(self.chkShowControlPoint_clicked)
        self.chkShowControlPoint.setSizePolicy(QSizePolicy(QSizePolicy.Policy.Fixed,QSizePolicy.Policy.Fixed))
        self.chkShowControlPoint.setFixedWidth(150)
        layout2.addWidget(self.chkShowControlPoint)

        self.btnViewUp = QPushButton("Up", self)
        self.btnViewUp.move(self.w - self.btnViewUp.sizeHint().width() - 10, 30)
        self.btnViewUp.clicked.connect(self.btnViewUp_clicked)
        self.btnViewUp.setSizePolicy(QSizePolicy(QSizePolicy.Policy.Fixed,QSizePolicy.Policy.Fixed))
        self.btnViewUp.setFixedWidth(150)
        layout2.addWidget(self.btnViewUp)
        self.btnViewDown = QPushButton("Down", self)
        self.btnViewDown.move(self.w - self.btnViewDown.sizeHint().width() - 10, 60)
        self.btnViewDown.clicked.connect(self.btnViewDown_clicked)
        self.btnViewDown.setSizePolicy(QSizePolicy(QSizePolicy.Policy.Fixed,QSizePolicy.Policy.Fixed))
        self.btnViewDown.setFixedWidth(150)
        layout2.addWidget(self.btnViewDown)
        self.btnViewLeft = QPushButton("Left", self)
        self.btnViewLeft.move(self.w - self.btnViewLeft.sizeHint().width() - 10, 90)
        self.btnViewLeft.clicked.connect(self.btnViewLeft_clicked)
        self.btnViewLeft.setSizePolicy(QSizePolicy(QSizePolicy.Policy.Fixed,QSizePolicy.Policy.Fixed))
        self.btnViewLeft.setFixedWidth(150)
        layout2.addWidget(self.btnViewLeft)
        self.btnViewRight = QPushButton("Right", self)
        self.btnViewRight.move(self.w - self.btnViewRight.sizeHint().width() - 10, 120)
        self.btnViewRight.clicked.connect(self.btnViewRight_clicked)
        self.btnViewRight.setSizePolicy(QSizePolicy(QSizePolicy.Policy.Fixed,QSizePolicy.Policy.Fixed))
        self.btnViewRight.setFixedWidth(150)
        layout2.addWidget(self.btnViewRight)

        self.btnZoomIn = QPushButton("Zoom In", self)
        self.btnZoomIn.move(self.w - self.btnZoomIn.sizeHint().width() - 10, 150)
        self.btnZoomIn.clicked.connect(self.btnZoomIn_clicked)
        self.btnZoomIn.setSizePolicy(QSizePolicy(QSizePolicy.Policy.Fixed,QSizePolicy.Policy.Fixed))
        self.btnZoomIn.setFixedWidth(150)
        layout2.addWidget(self.btnZoomIn)
        self.btnZoomOut = QPushButton("Zoom Out", self)
        self.btnZoomOut.move(self.w - self.btnZoomOut.sizeHint().width() - 10, 180)
        self.btnZoomOut.clicked.connect(self.btnZoomOut_clicked)
        self.btnZoomOut.setSizePolicy(QSizePolicy(QSizePolicy.Policy.Fixed,QSizePolicy.Policy.Fixed))
        self.btnZoomOut.setFixedWidth(150)
        layout2.addWidget(self.btnZoomOut)

        self.chkRunMovePoint = QCheckBox("Move Point", self)
        self.chkRunMovePoint.setChecked(self.movePoint)
        self.chkRunMovePoint.move(self.w - self.chkRunMovePoint.sizeHint().width() - 10, 210)
        self.chkRunMovePoint.stateChanged.connect(self.chkMovePoint_clicked)
        self.chkRunMovePoint.setSizePolicy(QSizePolicy(QSizePolicy.Policy.Fixed,QSizePolicy.Policy.Fixed))
        self.chkRunMovePoint.setFixedWidth(150)
        layout2.addWidget(self.chkRunMovePoint)

        self.btnDetectConvex = QPushButton("Detect Convex Point", self)
        self.btnDetectConvex.move(self.w - self.btnDetectConvex.sizeHint().width() - 10, 240)
        self.btnDetectConvex.resize(150,28)
        self.btnDetectConvex.clicked.connect(self.btnDetectConvex_clicked)
        self.btnDetectConvex.setSizePolicy(QSizePolicy(QSizePolicy.Policy.Fixed,QSizePolicy.Policy.Fixed))
        self.btnDetectConvex.setFixedWidth(150)
        layout2.addWidget(self.btnDetectConvex)

        layout3 = QHBoxLayout()
        self.lblAngle = QLabel('Angle: ', self)
        self.lblAngle.resize(50,28)
        self.lblAngle.move(self.w - 100 - 5, 270)
        self.lblAngle.setSizePolicy(QSizePolicy(QSizePolicy.Policy.Fixed,QSizePolicy.Policy.Fixed))
        self.lblAngle.setFixedWidth(50)
        layout3.addWidget(self.lblAngle)
        self.edtAngle = QLineEdit(self)
        self.edtAngle.setText(str(self.angle))
        self.edtAngle.resize(50,28)
        self.edtAngle.move(self.w - 50 - 5, 270)
        self.edtAngle.textChanged.connect(self.edtAngle_textChanged)
        self.edtAngle.setSizePolicy(QSizePolicy(QSizePolicy.Policy.Fixed,QSizePolicy.Policy.Fixed))
        self.edtAngle.setFixedWidth(50)
        layout3.addWidget(self.edtAngle)
        layout2.addLayout(layout3)

        self.btnCalcInOut = QPushButton("Check In/Out", self)
        self.btnCalcInOut.move(self.w - self.btnCalcInOut.sizeHint().width() - 10, 300)
        self.btnCalcInOut.clicked.connect(self.btnCalcInOut_clicked)
        self.btnCalcInOut.setSizePolicy(QSizePolicy(QSizePolicy.Policy.Fixed,QSizePolicy.Policy.Fixed))
        self.btnCalcInOut.setFixedWidth(150)
        layout2.addWidget(self.btnCalcInOut)
        layout2.setAlignment(Qt.AlignmentFlag.AlignTop)

        widget = QWidget()
        self.canvas = MyCanvas(self)
        self.canvas.setMouseTracking(True)
        layout1.addWidget(self.canvas,100)
        layout1.addLayout(layout2,20)
        widget.setLayout(layout1)

        self.setCentralWidget(widget)

        self.setMouseTracking(True)
        self.statusbar = self.statusBar()
        self.show()

    def closeEvent(self, e):
        fp = open('config.json', 'w')
        config = {}
        config['angle'] = self.angle
        config['v_org_x'] = self.v_org_x
        config['v_org_y'] = self.v_org_y
        config['v_w'] = self.v_w
        json.dump(config, fp)
        fp.close()

    def edtAngle_textChanged(self):
        self.angle = float(self.edtAngle.text())

    def mousePressEvent(self, e):
        self.statusbar.showMessage('click')
        if self.movePoint:
            self.runMovePoint(e.x(), e.y())
    def wheelEvent(self, event: QWheelEvent):
        print('wheel event(%d,%d)'%(event.angleDelta().x(), event.angleDelta().y()))
        if self.bCtrl:
            if event.angleDelta().y() > 0:
                self.zoomIn(self.mouse_x, self.mouse_y)
                self.update()
            else:
                self.zoomOut(self.mouse_x, self.mouse_y)
                self.update()
        elif self.bShift == False:
            if event.angleDelta().y() > 0:
                self.MoveUp()
                self.update()
            else:
                self.MoveDown()
                self.update()
        else:
            if event.angleDelta().y() > 0:
                self.MoveLeft()
                self.update()
            else:
                self.MoveRight()
                self.update()


    def keyPressEvent(self, e):
        if e.key() == Qt.Key_Control:
            self.bCtrl = True
        elif e.key() == Qt.Key_Shift:
            self.bShift = True

    def keyReleaseEvent(self, e):
        if e.key() == Qt.Key_Control:
            self.bCtrl = False
        elif e.key() == Qt.Key_Shift:
            self.bShift = False

    def mouseMoveEvent(self, event):
        x = event.x()
        y = event.y()
        self.mouse_x = x
        self.mouse_y = y
        msg = 'mouseMoveEvent: x=%d, y=%d' % (event.x(), event.y())
        msg1 = msg + ', view_x=%.3f, view_y=%.3f'%(self.scr_to_vw_x(x), self.scr_to_vw_y(y))
        self.statusbar.showMessage(msg1)
        print (msg)
        sel_i = self.searchPoint(x, y)
        if sel_i != -1:
            i = sel_i
            if i == 0:
                prev = len(bzPoints)-1
            else:
                prev = i - 1
            if i == len(bzPoints)-1:
                next = 0
            else:
                next = i + 1
            dx1 = bzPoints[next].x - bzPoints[i].x
            dy1 = bzPoints[next].y - bzPoints[i].y
            l1 = math.sqrt(dx1*dx1 + dy1*dy1)
            dx2 = bzPoints[prev].x - bzPoints[i].x
            dy2 = bzPoints[prev].y - bzPoints[i].y
            l2 = math.sqrt(dx2*dx2 + dy2*dy2)
            if l1 != 0 and l2 != 0:
                th = math.acos((dx1 * dx2 + dy1 * dy2)/l1/l2)
            else:
                th = 0
            self.statusbar.showMessage('selected point[%d]=(%.3f, %.3f), angle=%.3f'%(sel_i, bzPoints[sel_i].x, bzPoints[sel_i].y, th*180/math.pi))
        if self.selected_point != sel_i:
            self.selected_point = sel_i
            self.repaint()            

    def vw_to_scr_x(self, x):
        return (x - self.v_org_x)*self.scale
    def vw_to_scr_y(self, y):
        return (y - self.v_org_y)*self.scale
    def scr_to_vw_x(self, x):
        return x/self.scale + self.v_org_x
    def scr_to_vw_y(self, y):
        return y/self.scale + self.v_org_y
    

    def chkShowControlPoint_clicked(self):
        self.showControlPoint = not self.showControlPoint
        self.repaint()
    def chkMovePoint_clicked(self):
        self.movePoint = not self.movePoint
        self.repaint()
    def btnDetectConvex_clicked(self):
        if len(self.edtAngle.text()) > 0:
            angle_deg = float(self.edtAngle.text())
            angle_rad = angle_deg * math.pi / 180.0
            self.findSharpPoint(bzPoints, angle_rad)
            self.repaint()
    def findBoundingBox(self):
        x_min = bzPoints[0].x
        y_min = bzPoints[0].y
        x_max = x_min
        y_max = y_min
        for point in bzPoints[1:]:
            if x_min > point.x:
                x_min = point.x
            if y_min > point.y:
                y_min = point.y
            if x_max < point.x:
                x_max = point.x
            if y_max < point.y:
                y_max = point.y
        self.x_min = x_min                
        self.x_max = x_max
        self.y_min = y_min                
        self.y_max = y_max

    def btnCalcInOut_clicked(self):
        idx = 82
        x1 = bzPoints[idx].x
        y1 = bzPoints[idx].y
        x2 = bzPoints[idx+1].x
        y2 = bzPoints[idx+1].y
        x3 = bzPoints[idx+2].x
        y3 = bzPoints[idx+2].y
        self.lines = []
        self.lines.append([x1, y1])
        self.lines.append([x2, y2])
        self.lines.append([x3, y3])

        # bounding box
        self.findBoundingBox()
        # test if two lines cross
        idx = 81
        self.test_line_idx = idx
        if line.TestCross(line.Line(self.x_min, self.y_min, (x1+x3)*0.5, (y1+y3)*0.5), line.Line(bzPoints[idx].x, bzPoints[idx].y, bzPoints[idx+1].x, bzPoints[idx+1].y)):
            print('TestCross = True')
        else:
            print('TestCross = False')
        
        # test all lines in polygon with test line from test point
        cross_cnt = 0
        for idx in range(len(bzPoints)-1):
            if line.TestCross(line.Line(self.x_min, self.y_min, (x1+x3)*0.5, (y1+y3)*0.5),line.Line(bzPoints[idx].x, bzPoints[idx].y, bzPoints[idx+1].x, bzPoints[idx+1].y)):
                cross_cnt = cross_cnt + 1
        print('cross_cnt=%d'%cross_cnt)
        self.repaint()

    def MoveUp(self):
        self.v_org_y = self.v_org_y + self.h / self.scale * 0.1
    def MoveDown(self):
        self.v_org_y = self.v_org_y - self.h / self.scale * 0.1
    def MoveLeft(self):
        self.v_org_x = self.v_org_x + self.w / self.scale * 0.1
    def MoveRight(self):
        self.v_org_x = self.v_org_x - self.w / self.scale * 0.1

    def btnViewUp_clicked(self):
        self.MoveUp()
        self.repaint()
    def btnViewDown_clicked(self):
        self.MoveDown()
        self.repaint()
    def btnViewLeft_clicked(self):
        self.MoveLeft()
        self.repaint()
    def btnViewRight_clicked(self):
        self.MoveRight()
        self.repaint()

    def zoomIn(self, x, y):
        self.scale = self.scale * self.zoomFactor
        self.v_org_x = self.v_org_x + x/self.scale*(self.zoomFactor - 1.0)
        self.v_org_y = self.v_org_y + y/self.scale*(self.zoomFactor - 1.0)
        self.v_w = self.w/self.scale
        self.v_h = self.h/self.scale
    def zoomOut(self, x, y):
        self.scale = self.scale / self.zoomFactor
        self.v_org_x = self.v_org_x + x/self.scale*(1.0-self.zoomFactor)/self.zoomFactor
        self.v_org_y = self.v_org_y + y/self.scale*(1.0-self.zoomFactor)/self.zoomFactor
        self.v_w = self.w/self.scale
        self.v_h = self.h/self.scale

    def btnZoomIn_clicked(self):
        self.zoomIn(self.mouse_x, self.mouse_y)
        self.repaint()
    def btnZoomOut_clicked(self):
        self.zoomOut(self.mouse_x, self.mouse_y)
        self.repaint()

    def findSharpPoint(self, bzPoints, angle_rad):
        self.findBoundingBox()
        for i in range(len(bzPoints)):
            bzPoints[i].acute = False
            if i == 0:
                prev = len(bzPoints)-1
            else:
                prev = i - 1
            if i == len(bzPoints)-1:
                next = 0
            else:
                next = i + 1
            dx1 = bzPoints[next].x - bzPoints[i].x
            dy1 = bzPoints[next].y - bzPoints[i].y
            l1 = math.sqrt(dx1*dx1 + dy1*dy1)
            dx2 = bzPoints[prev].x - bzPoints[i].x
            dy2 = bzPoints[prev].y - bzPoints[i].y
            l2 = math.sqrt(dx2*dx2 + dy2*dy2)
            if l1 != 0 and l2 != 0:
                th = math.acos((dx1 * dx2 + dy1 * dy2)/l1/l2)
                math.atan2(dy1, dx1)
                math.atan2(dy2, dx2)
                if th < angle_rad:
                    cross_cnt = 0
                    for idx in range(len(bzPoints)):
                        if idx == len(bzPoints)-1:
                            idx_next = 0
                        else:
                            idx_next = idx + 1
                        if line.TestCross(line.Line(self.x_min, self.y_min, (bzPoints[prev].x+bzPoints[next].x)*0.5, (bzPoints[prev].y+bzPoints[next].y)*0.5),line.Line(bzPoints[idx].x, bzPoints[idx].y, bzPoints[idx_next].x, bzPoints[idx_next].y)):
                            cross_cnt = cross_cnt + 1
                    print('idx=%d, cross_cnt=%d'%(i, cross_cnt))
                    if (cross_cnt % 2) == 0:
                        bzPoints[i].acute = True 
                    # bzPoints[i].acute = True 
                    
    def findSharpPoint2(self, bzPoints, angle):
        for i in range(len(bzPoints)):
            x = bzPoints[i].x
            y = bzPoints[i].y
            dx1 = bzPoints[i].x_g1 - x
            dy1 = bzPoints[i].y_g1 - y
            l1 = math.sqrt(dx1*dx1 + dy1*dy1)
            dx2 = bzPoints[i].x_g2 - x
            dy2 = bzPoints[i].y_g2 - y
            l2 = math.sqrt(dx2*dx2 + dy2*dy2)
            if l1 != 0 and l2 != 0:
                th = math.acos((dx1 * dx2 + dy1 * dy2)/l1/l2)
                if th < angle:
                    bzPoints[i].acute2 = True    

    def searchPoint(self, x, y):
        x_max = self.w
        y_max = self.h
        dist_min = math.sqrt(x_max*x_max + y_max*y_max)
        sel_i = -1
        for i in range(len(bzPoints)):
            dx = bzPoints[i].x - self.scr_to_vw_x(x)
            dy = bzPoints[i].y - self.scr_to_vw_y(y)
            dist = math.sqrt(dx*dx + dy*dy)
            if dist < dist_min:
                dist_min = dist
                sel_i = i
        return sel_i

    def runMovePointByIdex(self, sel_i):
        self.statusbar.showMessage('run selected point[%d]=(%.3f, %.3f)'%(sel_i, bzPoints[sel_i].x, bzPoints[sel_i].y))
        x = bzPoints[sel_i].x
        y = bzPoints[sel_i].y
        x_g1_old = bzPoints[sel_i].x_g1
        y_g1_old = bzPoints[sel_i].y_g1
        if sel_i == 0:
            sel_prev = len(bzPoints)-1
        else:
            sel_prev = sel_i - 1
        x_g = bzPoints[sel_prev].x_g2
        y_g = bzPoints[sel_prev].y_g2
        dx = x_g - x
        dy = y_g - y
        l = math.sqrt(dx*dx + dy*dy)
        x_g1_new = x + dx*0.3
        y_g1_new = y + dy*0.3
        bzPoints[sel_i].x_g1 = x_g1_new
        bzPoints[sel_i].y_g1 = y_g1_new

        if sel_i == len(bzPoints)-1:
            sel_next = 0
        else:
            sel_next = sel_i + 1
        x_g = bzPoints[sel_next].x_g1
        y_g = bzPoints[sel_next].y_g1
        dx = x_g - x
        dy = y_g - y
        l = math.sqrt(dx*dx + dy*dy)
        x_g2_new = x + dx*0.3
        y_g2_new = y + dy*0.3
        bzPoints[sel_i].x_g2 = x_g2_new
        bzPoints[sel_i].y_g2 = y_g2_new

        msg = 'g1_old: (%.3f, %.3f), g1_new: (%.3f, %.3f)' % (x_g1_old, y_g1_old, x_g1_new, y_g1_new)
        print(msg)
        dx = x_g1_new - x
        dy = y_g1_new - y
        l1 = math.sqrt(dx*dx + dy*dy)
        dx = x_g2_new - x
        dy = y_g2_new - y
        l2 = math.sqrt(dx*dx + dy*dy)
        x_new = (x_g1_new*l2 + x_g2_new*l1)/(l1+l2)
        y_new = (y_g1_new*l2 + y_g2_new*l1)/(l1+l2)
        bzPoints[sel_i].x = x_new
        bzPoints[sel_i].y = y_new

    def runMovePoint(self, x, y):
        self.statusbar.showMessage('move')
        sel_i = self.searchPoint(x, y)
        if sel_i != -1:
            self.runMovePointByIdex(sel_i)
            self.repaint()


    def paintEvent(self, e):
        qp = QPainter()
        qp.begin(self)
        text = 'v_org=(%.3f, %.3f)'%(self.v_org_x, self.v_org_y)
        qp.drawText(20,20, text)
        text = 'scale=(%.3f)'%(self.scale)
        qp.drawText(20,40, text)
        text = 'v_center=(%.3f, %.3f)'%(self.scr_to_vw_x(self.w/2), self.scr_to_vw_y(self.h/2))
        qp.drawText(20,60, text)
        text = 'v_size=(%.3f, %.3f)'%(self.v_w, self.v_h)
        qp.drawText(20,80, text)

        # qp.drawLine(0,0,int(self.w/2),int(self.h/2))
        self.draw_line(qp)
        self.draw_point(qp)
        if self.showControlPoint:
            self.draw_control_point(qp)
        if self.selected_point != -1:
            x = self.vw_to_scr_x(bzPoints[self.selected_point].x) - 10
            y = self.vw_to_scr_y(bzPoints[self.selected_point].y) - 10
            qp.setPen(QPen(Qt.blue, 3, Qt.DotLine))
            qp.drawEllipse(int(x), int(y), 20, 20)
        if hasattr(self, 'lines'):
            qp.setPen(QPen(Qt.red, 3, Qt.DotLine))
            x1 = self.vw_to_scr_x(self.lines[0][0])
            y1 = self.vw_to_scr_y(self.lines[0][1])
            x2 = self.vw_to_scr_x(self.lines[1][0])
            y2 = self.vw_to_scr_y(self.lines[1][1])
            qp.drawLine(int(x1), int(y1), int(x2), int(y2))
        if hasattr(self, 'x_min') and hasattr(self, 'test_line_idx'):
            qp.setPen(QPen(Qt.red, 3, Qt.DotLine))
            x1 = self.vw_to_scr_x(self.x_min)
            y1 = self.vw_to_scr_y(self.y_min)
            x2 = self.vw_to_scr_x(self.x_max)
            y2 = self.vw_to_scr_y(self.y_max)
            qp.drawRect(int(x1), int(y1), int(x2)-int(x1), int(y2)-int(y1))

            x1 = self.vw_to_scr_x(bzPoints[self.test_line_idx].x)
            y1 = self.vw_to_scr_y(bzPoints[self.test_line_idx].y)
            x2 = self.vw_to_scr_x(bzPoints[self.test_line_idx+1].x)
            y2 = self.vw_to_scr_y(bzPoints[self.test_line_idx+1].y)
            qp.drawLine(int(x1), int(y1), int(x2), int(y2))
        # p_test to p_edge_bbox
        if hasattr(self, 'x_min') and hasattr(self, 'lines'):
            qp.setPen(QPen(Qt.red, 3, Qt.DotLine))
            x1 = self.vw_to_scr_x(self.x_min)
            y1 = self.vw_to_scr_y(self.y_min)
            x2 = self.vw_to_scr_x((self.lines[0][0]+self.lines[2][0])*0.5)
            y2 = self.vw_to_scr_y((self.lines[0][1]+self.lines[2][1])*0.5)
            qp.drawLine(int(x1), int(y1), int(x2), int(y2))

        if hasattr(self, 'x_sol'):
            # draw cross point
            qp.setPen(QPen(Qt.blue, 15))
            x1 = self.vw_to_scr_x(self.x_sol)
            y1 = self.vw_to_scr_y(self.y_sol)
            qp.drawPoint(int(x1), int(y1))
        qp.end()

    def draw_line(self, qp):
        qp.setPen(QPen(Qt.blue, 2))
        for i in range(int(len(num)/6)-1):
            x1 = self.vw_to_scr_x(bzPoints[i].x)
            y1 = self.vw_to_scr_y(bzPoints[i].y)
            x2 = self.vw_to_scr_x(bzPoints[i+1].x)
            y2 = self.vw_to_scr_y(bzPoints[i+1].y)
            qp.drawLine(int(x1), int(y1), int(x2), int(y2))
        x1 = self.vw_to_scr_x(bzPoints[len(bzPoints)-1].x)
        y1 = self.vw_to_scr_y(bzPoints[len(bzPoints)-1].y)
        x2 = self.vw_to_scr_x(bzPoints[0].x)
        y2 = self.vw_to_scr_y(bzPoints[0].y)
        qp.drawLine(int(x1), int(y1), int(x2), int(y2))

    def draw_point(self, qp):
        for i in range(len(bzPoints)):
            if bzPoints[i].acute == True:
                qp.setPen(QPen(Qt.red, 5))
            else:
                qp.setPen(QPen(Qt.yellow, 5))
            x1 = self.vw_to_scr_x(bzPoints[i].x)
            y1 = self.vw_to_scr_y(bzPoints[i].y)
            qp.drawPoint(int(x1), int(y1))

    def draw_control_point(self, qp):
        qp.setPen(QPen(Qt.red, 2))
        for i in range(len(bzPoints)):
            x = self.vw_to_scr_x(bzPoints[i].x)
            y = self.vw_to_scr_y(bzPoints[i].y)
            x1 = self.vw_to_scr_x(bzPoints[i].x_g1)
            y1 = self.vw_to_scr_y(bzPoints[i].y_g1)
            qp.drawLine(int(x), int(y), int(x1), int(y1))
            qp.drawPoint(int(x), int(y))
            qp.drawPoint(int(x1), int(y1))
            x1 = self.vw_to_scr_x(bzPoints[i].x_g2)
            y1 = self.vw_to_scr_y(bzPoints[i].y_g2)
            qp.drawPoint(int(x1), int(y1))
            qp.drawLine(int(x), int(y), int(x1), int(y1))

if __name__ == '__main__':
    app = QApplication(sys.argv)
    ex = MyApp()
    sys.exit(app.exec_())

    